# Maintainer: Yichao Yu <yyc1992@gmail.com>

pkgbase=julia-git-precompiled-packages
_jlpackages=(
###=== JLPKG_JLNAME_LIST {{
  ADTypes
  AMD
  ASL_jll
  AWS
  AWSS3
  AbstractAlgebra
  AbstractDifferentiation
  AbstractFFTs
  AbstractLattices
  AbstractTrees
  Accessors
  Adapt
  Alpine
  AmplNLWriter
  AndorSIF
  Animations
  Antic_jll
  Aqua
  Arb_jll
  ArgCheck
  ArnoldiMethod
  Arpack
  Arpack_jll
  ArrayInterface
  ArrayLayouts
  Arrow
  ArrowTypes
  Atomix
  Attr_jll
  Automa
  AxisAlgorithms
  AxisArrays
  BFloat16s
  BandedMatrices
  BangBang
  BaseType
  Baselet
  BenchmarkTools
  Bijections
  BitBasis
  BitFlags
  BitIntegers
  BitTwiddlingConvenienceFunctions
  BlockArrays
  BlockBandedMatrices
  BlockDiagonals
  Bloqade
  BloqadeExpr
  BloqadeKrylov
  BloqadeLattices
  BloqadeMIS
  BloqadeODE
  BloqadeSchema
  BloqadeWaveforms
  Blosc
  Blosc_jll
  Bonito
  BoundaryValueDiffEq
  Braket
  BufferedStreams
  Bzip2_jll
  CDDLib
  CEnum
  CGcoefficient
  CPUSummary
  CRlibm
  CRlibm_jll
  CSTParser
  CSV
  CacheServers
  Cairo
  Cairo_jll
  Calcium_jll
  Calculus
  CatIndices
  CategoricalArrays
  Cbc
  Cbc_jll
  Cgl_jll
  ChainRules
  ChainRulesCore
  ChainRulesTestUtils
  ChangesOfVariables
  CircularArrays
  Clang
  Clang_jll
  CloseOpenIntervals
  Clp
  Clp_jll
  Clustering
  CodeTracking
  CodecBase
  CodecBzip2
  CodecLz4
  CodecXz
  CodecZlib
  CodecZstd
  CoinUtils_jll
  ColorBrewer
  ColorSchemes
  ColorTypes
  ColorVectorSpace
  Colors
  Combinatorics
  CommonMark
  CommonSolve
  CommonSubexpressions
  Compat
  CompositeTypes
  CompositionsBase
  ComputationalResources
  ConcreteStructs
  ConcurrentSim
  ConcurrentUtilities
  Conda
  CondaPkg
  Configurations
  ConjugateGradients
  ConsoleProgressMonitor
  ConstructionBase
  Contour
  CoordinateTransformations
  CpuId
  Crayons
  Cubature
  Cubature_jll
  CustomUnitRanges
  DataAPI
  DataFrames
  DataStructures
  DataValueInterfaces
  DecFP
  DecFP_jll
  DeepDiffs
  DefineSingletons
  DelaunayTriangulation
  DelayDiffEq
  Deno_jll
  DensityInterface
  Dierckx
  Dierckx_jll
  DiffEqBase
  DiffEqCallbacks
  DiffEqNoiseProcess
  DiffResults
  DiffRules
  DifferentialEquations
  DimensionalData
  Distances
  Distributions
  DocStringExtensions
  DomainSets
  DualNumbers
  DynamicPolynomials
  DynamicQuantities
  EarCut_jll
  EliminateGraphs
  EllipsisNotation
  EnumX
  Enzyme
  EnzymeCore
  Enzyme_jll
  EpollShim_jll
  ErrorfreeArithmetic
  ExactPredicates
  ExceptionUnwrapping
  Expat_jll
  ExponentialAction
  ExponentialUtilities
  ExprTools
  ExproniconLite
  Extents
  EzXML
  FFMPEG
  FFMPEG_jll
  FFTViews
  FFTW
  FFTW_jll
  FLINT_jll
  FameSVD
  FastAlmostBandedMatrices
  FastBroadcast
  FastClosures
  FastExpm
  FastGaussQuadrature
  FastLapackInterface
  FastLevenbergMarquardt
  FastRounding
  FileIO
  FilePaths
  FilePathsBase
  FillArrays
  FindFirstFunctions
  FiniteDiff
  FiniteDifferences
  FixedPointNumbers
  FlameGraphs
  FoldingTrees
  Fontconfig_jll
  Format
  Formatting
  ForwardDiff
  FreeType
  FreeType2_jll
  FreeTypeAbstraction
  FreqTables
  FriBidi_jll
  FunctionWrappers
  FunctionWrappersWrappers
  Functors
  GLFW_jll
  GLPK
  GLPK_jll
  GPUArrays
  GPUArraysCore
  GPUCompiler
  GR
  GR_jll
  GSL
  GSL_jll
  GarishPrint
  GaussQuadrature
  GeneralizedGenerated
  GenericLinearAlgebra
  GenericSchur
  GeoInterface
  GeometryBasics
  Gettext_jll
  Ghostscript_jll
  GitHub
  GitHubActions
  Glib_jll
  Glob
  Graphics
  Graphite2_jll
  Graphs
  GridLayoutBase
  Grisu
  Groebner
  GroupsCore
  H5Zbitshuffle
  H5Zblosc
  H5Zbzip2
  H5Zlz4
  H5Zzstd
  HCubature
  HDF5
  HDF5_jll
  HTTP
  HYPRE
  HYPRE_jll
  HalfIntegers
  HarfBuzz_jll
  HiGHS
  HiGHS_jll
  HistogramThresholding
  HostCPUFeatures
  Hwloc_jll
  HypergeometricFunctions
  Hyperscript
  HypothesisTests
  IJulia
  ILog2
  IRTools
  IfElse
  ImageAxes
  ImageBase
  ImageBinarization
  ImageContrastAdjustment
  ImageCore
  ImageCorners
  ImageDistances
  ImageFiltering
  ImageIO
  ImageInTerminal
  ImageMagick
  ImageMagick_jll
  ImageMetadata
  ImageMorphology
  ImageQualityIndexes
  ImageSegmentation
  ImageShow
  ImageTransformations
  Images
  Imath_jll
  IndirectArrays
  Inflate
  IniFile
  InitialValues
  InlineStrings
  IntegerMathUtils
  IntegralArrays
  IntelOpenMP_jll
  Interfaces
  Interpolations
  IntervalArithmetic
  IntervalRootFinding
  IntervalSets
  Intervals
  InverseFunctions
  InvertedIndices
  Ipopt
  Ipopt_jll
  IrrationalConstants
  Isoband
  IterTools
  IterativeSolvers
  IteratorInterfaceExtensions
  JLD
  JLD2
  JLFzf
  JSON
  JSON3
  JpegTurbo
  JpegTurbo_jll
  JuMP
  JuliaFormatter
  JuliaInterpreter
  JuliaSyntax
  JuliaVariables
  JumpProcesses
  Juniper
  Juno
  KLU
  KernelAbstractions
  KernelDensity
  Krylov
  KrylovKit
  LAME_jll
  LAPACK_jll
  LDLFactorizations
  LERC_jll
  LLVM
  LLVMExtra_jll
  LLVMOpenMP_jll
  LRUCache
  LZO_jll
  LaTeXStrings
  LabelledArrays
  LambertW
  Latexify
  LatticeRules
  LayoutPointers
  Lazy
  LazyArrays
  LazyModules
  LeastSquaresOptim
  LeftChildRightSiblingTrees
  LegibleLambdas
  LevyArea
  LibArchive_jll
  Libffi_jll
  Libgcrypt_jll
  Libglvnd_jll
  Libgpg_error_jll
  Libiconv_jll
  Libmount_jll
  Librsvg_jll
  Libtiff_jll
  Libuuid_jll
  LightXML
  LineSearches
  LinearAlgebraX
  LinearMaps
  LinearOperators
  LinearSolve
  LittleCMS_jll
  LogExpFunctions
  LoggingExtras
  LoopVectorization
  Loraine
  LoweredCodeUtils
  LsqFit
  Luxor
  LuxorGraphPlot
  LuxurySparse
  Lz4_jll
  MAT
  MD5
  METIS_jll
  MKL
  MKL_jll
  MLStyle
  MPC_jll
  MPI
  MPICH_jll
  MPIPreferences
  MPItrampoline_jll
  MUMPS_seq_jll
  MacroTools
  MadNLP
  Makie
  MakieCore
  ManualMemory
  MappedArrays
  MarchingCubes
  MathOptInterface
  MathTeXEngine
  MatrixFactorizations
  MaybeInplace
  MbedTLS
  Measurements
  Measures
  Media
  MetaGraphs
  MicroCollections
  MicroMamba
  MicrosoftMPI_jll
  Missings
  Mocking
  ModelingToolkit
  Mods
  MonteCarloMeasurements
  MosaicViews
  MsgPack
  MuladdMacro
  Multisets
  MultivariatePolynomials
  Mustache
  MutableArithmetics
  NLPModels
  NLSolversBase
  NLopt
  NLopt_jll
  NLsolve
  NNlib
  NaNMath
  NameResolution
  NamedArrays
  NamedTupleTools
  NearestNeighbors
  Nemo
  Netpbm
  NetworkLayout
  NodeJS
  NonlinearSolve
  ODE
  ODEInterface
  ODEInterface_jll
  ObjectFile
  Observables
  OffsetArrays
  Ogg_jll
  OpenBLAS32_jll
  OpenCL
  OpenCL_jll
  OpenEXR
  OpenEXR_jll
  OpenJpeg_jll
  OpenMPI_jll
  OpenSSL
  OpenSSL_jll
  OpenSpecFun_jll
  Optim
  Optimisers
  Optimization
  OptimizationBase
  Opus_jll
  OrderedCollections
  OrdinaryDiffEq
  Osi_jll
  PCRE_jll
  PDMats
  PMIx_jll
  PNGFiles
  PackageExtensionCompat
  Packing
  PaddedViews
  Pajarito
  Pango_jll
  ParallelMergeCSR
  Parameters
  Pardiso
  Parsers
  PartialFunctions
  PartitionedArrays
  Pavito
  Permutations
  Pidfile
  PikaParser
  Pipe
  Pixman_jll
  PkgVersion
  PlotThemes
  PlotUtils
  Plots
  PoissonRandom
  Polyester
  PolyesterWeave
  PolygonOps
  Polyhedra
  Polynomials
  PooledArrays
  PositiveFactorizations
  PreallocationTools
  PrecompileTools
  Preferences
  PrettyPrint
  PrettyTables
  Primes
  ProgressLogging
  ProgressMeter
  PyCall
  PyPlot
  PythonCall
  QOI
  QPSReader
  Qt5Base_jll
  Qt6Base_jll
  QuadGK
  QuantumClifford
  QuantumCumulants
  QuantumInterface
  QuantumOptics
  QuantumOpticsBase
  QuantumSavory
  QuantumSymbolics
  QuasiMonteCarlo
  Quaternions
  Random123
  RandomExtensions
  RandomMatrices
  RandomNumbers
  RangeArrays
  RationalRoots
  Ratios
  RealDot
  RecipesBase
  RecipesPipeline
  RecursiveArrayTools
  RecursiveFactorization
  Reexport
  Referenceables
  RegionTrees
  RelocatableFolders
  Requires
  ResettableStacks
  ResumableFunctions
  Retry
  ReverseDiff
  Revise
  Richardson
  RingLists
  Rmath
  Rmath_jll
  Roots
  Rotations
  RoundingEmulator
  Rsvg
  RuntimeGeneratedFunctions
  SIMD
  SIMDDualNumbers
  SIMDTypes
  SLEEFPirates
  SPRAL_jll
  SciMLBase
  SciMLNLSolve
  SciMLOperators
  SciMLStructures
  Scratch
  SentinelArrays
  SetRounding
  Setfield
  ShaderAbstractions
  ShiftedArrays
  Showoff
  SignedDistanceFields
  SimpleBufferStream
  SimpleGraphs
  SimpleNonlinearSolve
  SimplePartitions
  SimplePolynomials
  SimpleRandom
  SimpleTraits
  SimpleUnPack
  SimpleWeightedGraphs
  Sixel
  Sobol
  SodiumSeal
  SoftGlobalScope
  SolverCore
  SortingAlgorithms
  SparseDiffTools
  SparseInverseSubset
  SparseMatricesCSR
  Sparspak
  SpecialFunctions
  SplittablesBase
  StableHashTraits
  StackViews
  Static
  StaticArrayInterface
  StaticArrays
  StaticArraysCore
  StatsAPI
  StatsBase
  StatsFuns
  StatsModels
  SteadyStateDiffEq
  StochasticDiffEq
  StrideArraysCore
  Strided
  StridedViews
  StringDistances
  StringEncodings
  StringManipulation
  StructArrays
  StructIO
  StructTypes
  SumTypes
  Sundials
  Sundials_jll
  Suppressor
  SymDict
  SymEngine
  SymEngine_jll
  SymbolicIndexingInterface
  SymbolicLimits
  SymbolicUtils
  Symbolics
  TZJData
  TableTraits
  Tables
  TensorCore
  TermInterface
  TerminalLoggers
  ThreadPools
  ThreadingUtilities
  ThreadsX
  TiffImages
  TiledIteration
  TimeZones
  TimerOutputs
  Tokenize
  Tracker
  TranscodingStreams
  Transducers
  TreeViews
  TriangularSolve
  Tricks
  TriplotBase
  TruncatedStacktraces
  Tulip
  TupleTools
  URIs
  UnPack
  UnicodeFun
  UnicodePlots
  Unitful
  UnitfulLatexify
  Unityper
  UnsafeArrays
  UnsafeAtomics
  UnsafeAtomicsLLVM
  UnsafePointers
  Unzip
  VectorInterface
  VectorizationBase
  VersionParsing
  VertexSafeGraphs
  VideoIO
  Vulkan_Loader_jll
  WGLMakie
  Wayland_jll
  Wayland_protocols_jll
  WeakRefStrings
  WidgetsBase
  WidthLimitedIO
  WignerSymbols
  WoodburyMatrices
  WorkerUtilities
  XML2_jll
  XMLDict
  XSLT_jll
  XTermColors
  XZ_jll
  Xorg_libICE_jll
  Xorg_libSM_jll
  Xorg_libX11_jll
  Xorg_libXau_jll
  Xorg_libXcursor_jll
  Xorg_libXdmcp_jll
  Xorg_libXext_jll
  Xorg_libXfixes_jll
  Xorg_libXi_jll
  Xorg_libXinerama_jll
  Xorg_libXrandr_jll
  Xorg_libXrender_jll
  Xorg_libpthread_stubs_jll
  Xorg_libxcb_jll
  Xorg_libxkbfile_jll
  Xorg_xcb_util_cursor_jll
  Xorg_xcb_util_image_jll
  Xorg_xcb_util_jll
  Xorg_xcb_util_keysyms_jll
  Xorg_xcb_util_renderutil_jll
  Xorg_xcb_util_wm_jll
  Xorg_xkbcomp_jll
  Xorg_xkeyboard_config_jll
  Xorg_xtrans_jll
  YAML
  Yao
  YaoAPI
  YaoArrayRegister
  YaoBlocks
  YaoSubspaceArrayReg
  YaoSym
  ZMQ
  ZeroMQ_jll
  Zstd_jll
  Zygote
  ZygoteRules
  acl_jll
  bitshuffle_jll
  cddlib_jll
  eudev_jll
  fzf_jll
  gdk_pixbuf_jll
  gperf_jll
  isoband_jll
  libaec_jll
  libaom_jll
  libass_jll
  libevdev_jll
  libevent_jll
  libfdk_aac_jll
  libinput_jll
  libpng_jll
  libsixel_jll
  libsodium_jll
  libvorbis_jll
  micromamba_jll
  mtdev_jll
  prrte_jll
  x264_jll
  x265_jll
  xkbcommon_jll
###=== }} JLPKG_JLNAME_LIST
)
pkgname=()
pkgver=20240329.054939
pkgrel=1
pkgdesc="Precompiled packages for julia-git"
# This is against the official recommendation but
# having a shorter arch array significantly reduces the lint_pkgbuild time.
case $CARCH in
  i686|x86_64|armv7h|aarch64)
    arch=($CARCH)
    ;;
  *)
    arch=()
    ;;
esac
url="http://julialang.org"
license=('GPL')
depends=(julia-git)
makedepends=(git julia-git-package-env julia-pkg-scripts makepkg-lint-disable-hook
             blas-openblas blas64-openblas)
options=('debug' '!strip')
source=(julia-copy-compiled-pkgs.jl)
sha512sums=('ffa428646fabbe27a20d92adb2ca0d7336d634debe964d1f53255233623dc905927b69724d4612f513be42e3573f21f67aadd5e5aee753793d6988e96226fd79')

pkgver() {
  date -u +%Y%m%d.%H%M%S
}

build() {
  rm -rf arch-compiled
  mkdir -p arch-compiled

  _ver_short=$(julia --startup-file=no \
                     -e 'print(VERSION.major, ".", VERSION.minor)')

  echo "_ver_short=${_ver_short}" > build_vars

  compile_dir="/usr/share/julia/compiled/v$_ver_short"
  stdlib_dir="/usr/share/julia/stdlib/v$_ver_short"
  tgt_dir="${srcdir}/arch-compiled"
  julia julia-copy-compiled-pkgs.jl \
        "$stdlib_dir" "$compile_dir" "$tgt_dir" "${_jlpackages[@]}"
}

_package-jlpackage() {
  # Don't depend on the exact julia version to make it easier to install
  # a new julia version that without updating all the precompiled packages
  # In such a case the precompiled binaries won't be used but the packages
  # should still work.
  # depends+=("julia-git=$(pacman -Q julia-git | sed -e 's/^.* \([^ ]*\)$/\1/')")

  . ./build_vars

  stdlib_dir="/usr/share/julia/stdlib/v$_ver_short"

  jlpkg=$1
  srcpkg="julia-git-${jlpkg,,}-src"

  depends+=("$srcpkg")
  conflicts+=("julia-git-${jlpkg,,}-git") # Temporary
  replaces+=("julia-git-${jlpkg,,}-git") # Temporary

  arch_compile_dir="${pkgdir}/usr/lib/julia/arch-compiled/"
  mkdir -p "$arch_compile_dir"

  . "${srcdir}/arch-compiled/package-${jlpkg}_vars.sh"

  echo "Dependencies: ${depends[*]}"
  echo "Optional dependencies: ${optdepends[*]}"

  cp -r "${srcdir}/arch-compiled/$jlpkg" "${arch_compile_dir}/$jlpkg"
}

if grep -q lint_pkgbuild /usr/bin/makepkg &> /dev/null; then
  # HACK!
  # chroot build would source the PKGBUILD outside the chroot at least once.
  # if we are running without linting disabled, lie to the makepkg about
  # what we are building to skip the lengthy linting.
  pkgname=(julia-git-precompiled-packages)
  package_julia-git-precompiled-packages() {
    true
  }
else
  for jlpkg in "${_jlpackages[@]}"; do
    _pkg="julia-git-${jlpkg,,}"
    pkgname=("${pkgname[@]}" "${_pkg}")
    makedepends+=("${_pkg}-src")
    eval "package_${_pkg}() { _package-jlpackage ${jlpkg}; }"
  done
fi
