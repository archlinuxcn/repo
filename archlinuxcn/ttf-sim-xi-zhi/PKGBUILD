# Maintainer: Gavin Luo <lunt.luo@gmail.com>

pkgbase=ttf-sim-xi-zhi
pkgname=('ttf-sim-xi-hei' 'ttf-sim-xi-hei-plus' 'ttf-sim-zhi-song' 'ttf-sim-zhi-song-plus')
pkgver=1.026.2
pkgrel=1
pkgdesc='新晰黑体＆新致宋体：「霞鹜新晰黑」「霞鹜新致宋」兼容 Windows 内置「黑体」「宋体」度量数据和字符集的版本，基于 IPA Gothic、IPA Mincho 衍生。'
url='https://github.com/lxgw/SimXiZhi'
arch=('any')
license=('IPA')
source=(SimXiHei-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimXiHei.ttf
        SimXiHeiPlus-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimXiHeiPlus.ttf
        SimZhiSong-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimZhiSong.ttf
        SimZhiSongPlus-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimZhiSongPlus.ttf
        LICENSE-"${pkgver}"::https://raw.githubusercontent.com/lxgw/SimXiZhi/refs/tags/v1.026/IPA_Font_License_Agreement_v1.0.txt)
b2sums=('cbd5d05c8c688a65b02b13d2b78f31c2f16b2ce250ff25c183e1bc77d21b10ae267cf25ef3e6a7e1e1c319d4e9f9c835e87415f8dba54e6a2360fab442b5324d'
        '6264206fa764522676023c5504b3b63719284ca8b0cbc35734955626f6c8d09b854d1b80c73f9c2fe9c6d3dd2b06f9e259708f547cf95ac7b962be3c08a993db'
        '8dd5b060267d7751f4f6363c2500ce2a61bf4a9b94f320a04e0655978b37525cea88672b134dbee8570daab019bd0a0241b9ffff47355823515f3d8ec6dbba3b'
        '64e90d5fddb3515dff2493ed5aca34dd8cdeefeada4d3655b13484f249113c06dd3899457e0b0e30f77891f39121f7e33a77f6eccef1249d1b16c1da8067b213'
        'ccb79bec5d352b18591f925ddbbaf6d86a6274bfbbea318e126690e5b52ee8be80d2deb99ab7e5b5b1194e2b8c8ee47464713b89e75c629dd462f1a80691e38d')

declare -A _font_family=(
    [SimXiHei]='SimXiHei'
    [SimXiHeiPlus]='SimXiHei Plus'
    [SimZhiSong]='SimZhiSong'
    [SimZhiSongPlus]='SimZhiSong Plus'
)

declare -A _alias_map=(
    [SimXiHei]='SimHei 黑体'
    [SimXiHeiPlus]='SimHei 黑体'
    [SimZhiSong]='SimSun 宋体'
    [SimZhiSongPlus]='SimSun 宋体'
)

for _pkgname in "${pkgname[@]}"; do
    case "${_pkgname}" in
        "ttf-sim-xi-hei")
            _desc='新晰黑体：「霞鹜新晰黑」兼容 Windows 内置「黑体」度量数据和字符集的版本，基于 IPA Gothic 衍生。'
            ;;
        "ttf-sim-xi-hei-plus")
            _desc='新晰黑体＋：「霞鹜新晰黑」兼容 Windows 内置「黑体」度量数据和字符集的版本，基于 IPA Gothic 衍生，并将字汇扩充至 GB 18030-2022 实现级别 2，同时保持 GBK 向下兼容。'
            ;;
        "ttf-sim-zhi-song")
            _desc='新致宋体：「霞鹜新致宋」兼容 Windows 内置「宋体」度量数据和字符集的版本，基于 IPA Mincho 衍生。'
            ;;
        "ttf-sim-zhi-song-plus")
            _desc='新致宋体＋：「霞鹜新致宋」兼容 Windows 内置「宋体」度量数据和字符集的版本，基于 IPA Mincho 衍生，并将字汇扩充至 GB 18030-2022 实现级别 2，同时保持 GBK 向下兼容。'
            ;;
    esac

    _fontname=$(sed -r 's/(^|-)(\w)/\U\2/g' <<< "${_pkgname//ttf-/}")
    _aliases=${_alias_map[$_fontname]}
    _family=${_font_family[$_fontname]}

    eval "package_${_pkgname}() {
        pkgdesc='${_desc}'
        _package '${_fontname}' '${_family}' '${_aliases}'
    }"
done

_package() {
    local fontname=$1
    install -Dm644 "${srcdir}/${fontname}-${pkgver}".ttf   "${pkgdir}"/usr/share/fonts/TTF/"${fontname}".ttf
    install -Dm644 "${srcdir}/LICENSE-${pkgver}" "${pkgdir}"/usr/share/licenses/"${pkgname}"/LICENSE

    mkdir -p "${pkgdir}"/usr/share/fontconfig/conf.avail
    local config_file="${pkgdir}"/usr/share/fontconfig/conf.avail/67-"${pkgname//ttf-/}".fonts.conf

    local family=$2
    read -ra aliases <<<"$3"

    cat <<EOF > "${config_file}"
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
    <description>Replace Windows built-in "${aliases[0]}" with font "${family}"</description>
EOF


    for alias in "${aliases[@]}"; do
        cat <<EOF >> "${config_file}"
    <match target="pattern">
        <test qual="any" name="family"><string>${alias}</string></test>
        <edit name="family" mode="assign" binding="same"><string>${family}</string></edit>
    </match>
EOF
    done


    echo "</fontconfig>" >> "${config_file}"
}
