# Maintainer: Gavin Luo <lunt.luo@gmail.com>

pkgbase=ttf-sim-xi-zhi
pkgname=('ttf-sim-xi-hei' 'ttf-sim-xi-hei-plus' 'ttf-sim-zhi-song' 'ttf-sim-zhi-song-plus')
pkgver=1.026
pkgrel=3
pkgdesc='新晰黑体＆新致宋体：「霞鹜新晰黑」「霞鹜新致宋」兼容 Windows 内置「黑体」「宋体」度量数据和字符集的版本，基于 IPA Gothic、IPA Mincho 衍生。'
url='https://github.com/lxgw/SimXiZhi'
arch=('any')
license=('IPA')
source=(SimXiHei-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimXiHei.ttf
        SimXiHeiPlus-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimXiHeiPlus.ttf
        SimZhiSong-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimZhiSong.ttf
        SimZhiSongPlus-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimZhiSongPlus.ttf
        LICENSE-"${pkgver}"::https://raw.githubusercontent.com/lxgw/SimXiZhi/refs/tags/v1.026/IPA_Font_License_Agreement_v1.0.txt)
b2sums=('1259a7f34bc94dceb16abef11562b870e5aa958b4144b59d4cb0cf3752cec2b78471cc5aa9b110e50299defc9b7a2426cb5a17e179e5ef563795e4bb04132f4e'
        'd0d06e0152abb67ddfa4231539de3ccb83395c420b60755c48f0366fbffa7c78373d6bc6554b5621ced54c900f48acc1231f1a18c61895d5f7570c434d68a238'
        '553963ba50213f6f199e0efa42f1614efa4385936a2e808d01498863fce13200faf8ab1b2888112ae3aff971697617076e44f4c30c63bb9a5a23023f43924de0'
        '98012d15ccaae7861b785d6bd149425892fdc9d140dde5f34c62dd47d0b20b9445dd4e7a53db57ba79351511dbd8db23e56bfd5ddf497aa88343e846cf5d9a86'
        'ccb79bec5d352b18591f925ddbbaf6d86a6274bfbbea318e126690e5b52ee8be80d2deb99ab7e5b5b1194e2b8c8ee47464713b89e75c629dd462f1a80691e38d')

declare -A _font_family=(
    [SimXiHei]='SimXiHei'
    [SimXiHeiPlus]='SimXiHei Plus'
    [SimZhiSong]='SimZhiSong'
    [SimZhiSongPlus]='SimZhiSong Plus'
)

declare -A _alias_map=(
    [SimXiHei]='SimHei 黑体'
    [SimXiHeiPlus]='SimHei 黑体'
    [SimZhiSong]='SimSun 宋体'
    [SimZhiSongPlus]='SimSun 宋体'
)

for _pkgname in "${pkgname[@]}"; do
    case "${_pkgname}" in
        "ttf-sim-xi-hei")
            _desc='新晰黑体：「霞鹜新晰黑」兼容 Windows 内置「黑体」度量数据和字符集的版本，基于 IPA Gothic 衍生。'
            ;;
        "ttf-sim-xi-hei-plus")
            _desc='新晰黑体＋：「霞鹜新晰黑」兼容 Windows 内置「黑体」度量数据和字符集的版本，基于 IPA Gothic 衍生，并将字汇扩充至 GB 18030-2022 实现级别 2，同时保持 GBK 向下兼容。'
            ;;
        "ttf-sim-zhi-song")
            _desc='新致宋体：「霞鹜新致宋」兼容 Windows 内置「宋体」度量数据和字符集的版本，基于 IPA Mincho 衍生。'
            ;;
        "ttf-sim-zhi-song-plus")
            _desc='新致宋体＋：「霞鹜新致宋」兼容 Windows 内置「宋体」度量数据和字符集的版本，基于 IPA Mincho 衍生，并将字汇扩充至 GB 18030-2022 实现级别 2，同时保持 GBK 向下兼容。'
            ;;
    esac

    _fontname=$(sed -r 's/(^|-)(\w)/\U\2/g' <<< "${_pkgname//ttf-/}")
    _aliases=${_alias_map[$_fontname]}
    _family=${_font_family[$_fontname]}

    eval "package_${_pkgname}() {
        pkgdesc='${_desc}'
        _package '${_fontname}' '${_family}' '${_aliases}'
    }"
done

_package() {
    local fontname=$1
    install -Dm644 "${srcdir}/${fontname}-${pkgver}".ttf   "${pkgdir}"/usr/share/fonts/TTF/"${fontname}".ttf
    install -Dm644 "${srcdir}/LICENSE-${pkgver}" "${pkgdir}"/usr/share/licenses/"${pkgname}"/LICENSE

    mkdir -p "${pkgdir}"/usr/share/fontconfig/conf.avail
    local config_file="${pkgdir}"/usr/share/fontconfig/conf.avail/67-"${pkgname//ttf-/}".fonts.conf

    local family=$2
    read -ra aliases <<<"$3"

    cat <<EOF > "${config_file}"
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
    <description>Replace Windows built-in "${aliases[0]}" with font "${family}"</description>
EOF


    for alias in "${aliases[@]}"; do
        cat <<EOF >> "${config_file}"
    <match target="pattern">
        <test qual="any" name="family"><string>${alias}</string></test>
        <edit name="family" mode="assign" binding="same"><string>${family}</string></edit>
    </match>
EOF
    done


    echo "</fontconfig>" >> "${config_file}"
}
