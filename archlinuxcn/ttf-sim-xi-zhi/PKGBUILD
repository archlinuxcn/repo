# Maintainer: Gavin Luo <lunt.luo@gmail.com>

pkgbase=ttf-sim-xi-zhi
pkgname=('ttf-sim-xi-hei' 'ttf-sim-xi-hei-plus' 'ttf-sim-zhi-song' 'ttf-sim-zhi-song-plus')
pkgver=1.027
pkgrel=1
pkgdesc='新晰黑体＆新致宋体：「霞鹜新晰黑」「霞鹜新致宋」兼容 Windows 内置「黑体」「宋体」度量数据和字符集的版本，基于 IPA Gothic、IPA Mincho 衍生。'
url='https://github.com/lxgw/SimXiZhi'
arch=('any')
license=('IPA')
source=(SimXiHei-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimXiHei.ttf
        SimXiHeiPlus-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimXiHeiPlus.ttf
        SimZhiSong-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimZhiSong.ttf
        SimZhiSongPlus-"${pkgver}".ttf::"${url}"/releases/download/v"${pkgver}"/SimZhiSongPlus.ttf
        LICENSE-"${pkgver}"::https://raw.githubusercontent.com/lxgw/SimXiZhi/refs/tags/v1.026/IPA_Font_License_Agreement_v1.0.txt)
b2sums=('42f33635604a11c5aae2f0333281570c305eb8354bf6cc544e686398ae4d4f51c369ad09fb437aea00d73f25a0a0332904ad5811c34689eb7f8797f28ee7961d'
        '73c6b43738731d4df5a6ca3d35bde54ce18a035d596f8a199312436a066ab551f4fefc0711044aad86bc1db55444dbe6f0432ec820da7f570b32dbdacd28a2e8'
        'c59c328473dea0abe782aeccaa3d1a618764eeda406d474321875cd7da8ff9e9a931f6ad94a5cfb6690de58124cf20cceadd00fd9ab57adf2b895417af5c781e'
        'eac7c605c65552a6ca5cd381cbc767bc8d74fa5300ed632da4008e00f0754c627412747bba7fa32eebfad2832a5a1ee97ab1391c35b552caf09f7ac03e4413b7'
        'ccb79bec5d352b18591f925ddbbaf6d86a6274bfbbea318e126690e5b52ee8be80d2deb99ab7e5b5b1194e2b8c8ee47464713b89e75c629dd462f1a80691e38d')

declare -A _font_family=(
    [SimXiHei]='SimXiHei'
    [SimXiHeiPlus]='SimXiHei Plus'
    [SimZhiSong]='SimZhiSong'
    [SimZhiSongPlus]='SimZhiSong Plus'
)

declare -A _alias_map=(
    [SimXiHei]='SimHei 黑体'
    [SimXiHeiPlus]='SimHei 黑体'
    [SimZhiSong]='SimSun 宋体'
    [SimZhiSongPlus]='SimSun 宋体'
)

for _pkgname in "${pkgname[@]}"; do
    case "${_pkgname}" in
        "ttf-sim-xi-hei")
            _desc='新晰黑体：「霞鹜新晰黑」兼容 Windows 内置「黑体」度量数据和字符集的版本，基于 IPA Gothic 衍生。'
            ;;
        "ttf-sim-xi-hei-plus")
            _desc='新晰黑体＋：「霞鹜新晰黑」兼容 Windows 内置「黑体」度量数据和字符集的版本，基于 IPA Gothic 衍生，并将字汇扩充至 GB 18030-2022 实现级别 2，同时保持 GBK 向下兼容。'
            ;;
        "ttf-sim-zhi-song")
            _desc='新致宋体：「霞鹜新致宋」兼容 Windows 内置「宋体」度量数据和字符集的版本，基于 IPA Mincho 衍生。'
            ;;
        "ttf-sim-zhi-song-plus")
            _desc='新致宋体＋：「霞鹜新致宋」兼容 Windows 内置「宋体」度量数据和字符集的版本，基于 IPA Mincho 衍生，并将字汇扩充至 GB 18030-2022 实现级别 2，同时保持 GBK 向下兼容。'
            ;;
    esac

    _fontname=$(sed -r 's/(^|-)(\w)/\U\2/g' <<< "${_pkgname//ttf-/}")
    _aliases=${_alias_map[$_fontname]}
    _family=${_font_family[$_fontname]}

    eval "package_${_pkgname}() {
        pkgdesc='${_desc}'
        _package '${_fontname}' '${_family}' '${_aliases}'
    }"
done

_package() {
    local fontname=$1
    install -Dm644 "${srcdir}/${fontname}-${pkgver}".ttf   "${pkgdir}"/usr/share/fonts/TTF/"${fontname}".ttf
    install -Dm644 "${srcdir}/LICENSE-${pkgver}" "${pkgdir}"/usr/share/licenses/"${pkgname}"/LICENSE

    mkdir -p "${pkgdir}"/usr/share/fontconfig/conf.avail
    local config_file="${pkgdir}"/usr/share/fontconfig/conf.avail/67-"${pkgname//ttf-/}".fonts.conf

    local family=$2
    read -ra aliases <<<"$3"

    cat <<EOF > "${config_file}"
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
    <description>Replace Windows built-in "${aliases[0]}" with font "${family}"</description>
EOF


    for alias in "${aliases[@]}"; do
        cat <<EOF >> "${config_file}"
    <match target="pattern">
        <test qual="any" name="family"><string>${alias}</string></test>
        <edit name="family" mode="assign" binding="same"><string>${family}</string></edit>
    </match>
EOF
    done


    echo "</fontconfig>" >> "${config_file}"
}
