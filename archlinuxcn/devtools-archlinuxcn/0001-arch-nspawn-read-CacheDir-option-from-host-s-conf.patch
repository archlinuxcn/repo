From 9953c43d3b0144c0349c9c585e6b18b246846405 Mon Sep 17 00:00:00 2001
From: Evangelos Foutras <evangelos@foutrelis.com>
Date: Fri, 18 Mar 2022 17:16:24 +0200
Subject: [PATCH 1/5] arch-nspawn: read CacheDir option from host's conf

This went unnoticed on build.archlinux.org until we tried switching away
from its local /srv/ftp/ mirror. With a remote mirror, the chroots would
ignore all the cached packages under /srv/ftp/pool/{packages,community}.

With the local file:// mirror gone, arch-nspawn wouldn't mount the cache
directories from the host into the chroot. The fix is to read the option
from the host's pacman.conf, instead of the one given to arch-nspawn and
the one existing inside the working directory.
---
 arch-nspawn.in | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch-nspawn.in b/arch-nspawn.in
index 275cff7..b6c9cb1 100644
--- a/arch-nspawn.in
+++ b/arch-nspawn.in
@@ -50,7 +50,7 @@ shift 1
 [[ -z $working_dir ]] && die 'Please specify a working directory.'
 
 if (( ${#cache_dirs[@]} == 0 )); then
-	mapfile -t cache_dirs < <(pacman-conf --config "${pac_conf:-$working_dir/etc/pacman.conf}" CacheDir)
+	mapfile -t cache_dirs < <(pacman-conf CacheDir)
 fi
 
 # shellcheck disable=2016
-- 
2.36.1

