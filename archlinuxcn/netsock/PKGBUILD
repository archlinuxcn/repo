# Maintainer: Kimiblock Moe
pkgname=netsock
epoch=1
pkgver=0.2
pkgrel=2
epoch=
pkgdesc="Per-app firewall for the Portable sandbox"
arch=('x86_64' 'aarch64' 'loongarch64')
url="https://github.com/Kimiblock/netsock"
license=(GPL-3.0-or-later)
provides=(netsock)
groups=()
options=()
conflicts=(netsock)

depends=(
	nftables
	glibc
)

makedepends+=(
	"git"
	"go"
)

checkdepends=()

source=(source::git+https://github.com/Kimiblock/netsock.git#tag=${pkgver})

md5sums=('9f7febc73783054b1bd05f4cbf548ffe')

function prepare() {
	cd source
	git clean -fdx
}

function build() {
	cd "${srcdir}/source"
	go mod download -modcacherw
	export CGO_CPPFLAGS="${CPPFLAGS}"
	export CGO_CFLAGS="${CFLAGS}"
	export CGO_CXXFLAGS="${CXXFLAGS}"
	export CGO_LDFLAGS="${LDFLAGS}"
	export GOFLAGS="-buildmode=pie -trimpath -ldflags=-linkmode=external -mod=readonly -modcacherw"
	go build \
		-trimpath \
		-buildmode=pie \
		-modcacherw \
		-mod=readonly \
		-ldflags "-linkmode external -extldflags \"${LDFLAGS}\"" \
		.
}

function package() {
	cd "${srcdir}/source"
	install -vDm755 top.kimiblock.netsock "${pkgdir}/usr/bin/netsock"
	install -vDm644 netsock.service -t "${pkgdir}/usr/lib/systemd/system"
	install -vDm644 netsock.socket -t "${pkgdir}/usr/lib/systemd/system"
}
