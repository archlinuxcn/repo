# Maintainer: Kimiblock Moe

pkgname=telegram-portable
pkgver=6.2.5
pkgrel=1
epoch=1
pkgdesc="Telegram sandboxed by portable"
arch=('x86_64')
url="https://github.com/Kraftland/portable"
license=('GPL-3.0-or-later WITH OpenSSL-exception')
groups=()
provides=(telegram-desktop)
options=(!debug !strip)
depends=("portable"
  'abseil-cpp'
  'ada'
  'ffmpeg' 'libavfilter.so' 'libavformat.so' 'libavcodec.so' 'libavutil.so'
  'glib2'
  'hicolor-icon-theme'
  'hunspell'
  'kcoreaddons'
  'libavif'
  'libdispatch'
  'libheif'
  'libjxl'
  'libxcomposite'
  'libxdamage'
  'libxrandr'
  'libxtst'
  'libvpx' 'libvpx.so'
  'lz4'
  'minizip'
  'openal'
  'openh264' 'libopenh264.so'
  'openssl' 'libcrypto.so' 'libssl.so'
  'pipewire'
  'protobuf' 'libprotobuf-lite.so'
  'qt6-base'
  'qt6-imageformats'
  'qt6-svg'
  'qt6-wayland'
  'rnnoise'
  'xxhash')
conflicts=("telegram-desktop")

optdepends=()

makedepends+=(telegram-desktop)

checkdepends=()

source=(
	portable-config
	telegram-desktop.sh
	telegram-desktop.desktop
)


md5sums=('601d52651237e4f6d1d89ef3f8c7e346'
         '7df62cd08a94af40006c27f232471d26'
         '331de7dca46cab34e5b3cdba8a6d2f68')

function prepare() {
	pacman -Ql telegram-desktop >file.list
}

function package() {
	while IFS= read -r line; do
		file="$(echo "$line" | awk '{print $2}')"
		if [[ -d ${file} ]]; then
			echo "Omitting Directory"
		else
			install -Dm755 "${file}" "${pkgdir}/${file}"
		fi
	done < file.list
	rm -f "${pkgdir}/usr/share/applications"/*
	install -Dm755 "${pkgdir}/usr/bin/Telegram" -t "${pkgdir}/usr/lib/portable/overlay-usr"
	rm -f "${pkgdir}/usr/bin"/*
	rm -rf "${pkgdir}/usr/share/dbus-1/services"
	install -Dm644 portable-config \
		"${pkgdir}/usr/lib/portable/info/org.telegram.desktop/config"
	install -Dm755 "telegram-desktop.sh" \
		"${pkgdir}/usr/bin/telegram-desktop"
	install -Dm755 "telegram-desktop.sh" \
		"${pkgdir}/usr/bin/Telegram"
	install -Dm644 "telegram-desktop.desktop" "${pkgdir}/usr/share/applications/org.telegram.desktop.desktop"
	echo '''[Desktop Entry]
Type=Application
Name=Telegram Desktop
GenericName=Stub for MPRIS
Icon=org.telegram.desktop
TryExec=portable
Exec=env _portableConfig="org.telegram.desktop" portable -- %u
Terminal=false
NoDisplay=true''' >"${pkgdir}/usr/share/applications/telegram-desktop.desktop"
}
