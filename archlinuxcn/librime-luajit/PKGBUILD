# Maintainer: Gavin Luo <lunt.luo#gmail.com>
# Contributor: Felix Yan <felixonmars@archlinux.org>
# Contributor: GONG Chen <chen dot sst at gmail dot com>
# Contributor: 網軍總司令

pkgname=librime-luajit
pkgver=1.16.0
pkgrel=1
epoch=1
pkgdesc="Rime input method engine"
arch=('x86_64')
url="https://github.com/rime/librime"
license=('BSD-3-Clause')
depends=('boost-libs' 'capnproto' 'gcc-libs' 'glibc' 'opencc' 'yaml-cpp' 'leveldb' 'librime-data' 'luajit' 'google-glog' 'marisa')
makedepends=('git' 'cmake' 'boost' 'gtest' 'ninja')
source=("git+https://github.com/rime/librime.git#tag=$pkgver"
        "git+https://github.com/lotem/librime-octagram.git"
        "git+https://github.com/hchunhui/librime-lua.git"
        "git+https://github.com/rime/librime-charcode.git"
        "git+https://github.com/lotem/librime-proto.git"
        "git+https://github.com/rime/librime-predict.git")
sha512sums=('626a9666fc1368476bb9013c79c3bbd8a6e5852e74013896497aad897ecf564cf9e98eb0de9eefa5c5cbd586e6a5b010eb56bbbab4a08f9dd1da6c044a05ccde'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP')
provides=("librime=${pkgver}")
conflicts=(librime)

prepare() {
  cd librime/plugins
  ln -sf "$srcdir"/librime-octagram .
  ln -sf "$srcdir"/librime-lua .
  ln -sf "$srcdir"/librime-charcode .
  ln -sf "$srcdir"/librime-proto .
  ln -sf "$srcdir"/librime-predict .
}

build() {
  cd librime
  export CXXFLAGS="$CXXFLAGS -DNDEBUG -DGLOG_USE_GLOG_EXPORT -DGLOG_USE_GFLAGS"
  cmake . -GNinja -Bbuild -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_MERGED_PLUGINS=Off -DENABLE_EXTERNAL_PLUGINS=On -Wno-dev -DLUA_VERSION=luajit
  cmake --build build
}

check() {
  cd librime/build
  ninja test
}

package() {
  cd librime/build
  DESTDIR="$pkgdir" ninja install
  install -vDm 644 ../LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}
