# Maintainer: Kimiblock Moe
# Contributor: Francesco Masala <mail@francescomasala.me>
# Contributor: lotation <xlapsiu@gmail.com>

pkgname=bottles-bwrap
_pkgname=Bottles
pkgver=52.0
pkgrel=1
epoch=2
pkgdesc='Easily manage wine and proton prefix. Sandboxed by portable.'
arch=(any)
url="https://github.com/bottlesdevs/Bottles"
license=(GPL-3.0-only)
provides+=(bottles)
conflicts+=(bottles)
depends=(
	cabextract
	dconf
	gtk4
	gtksourceview5
	hicolor-icon-theme
	icoextract
	imagemagick
	libadwaita
	libportal-gtk4
	p7zip
	patool
	python
	python-chardet
	python-fvs
	python-gobject
	python-markdown
	python-orjson
	python-pathvalidate
	python-pycurl
	python-requests
	python-steamgriddb
	python-yaml
	webkit2gtk
	xorg-xdpyinfo
	vkbasalt-cli
	portable
	gamemode
)

optdepends=(
	gvfs
	lib32-gamemode
	lib32-gnutls
	lib32-vkd3d
	lib32-vulkan-icd-loader
	vkd3d
	vulkan-icd-loader
	wine
)
makedepends=(
	blueprint-compiler
	meson
	ninja
	git
)
source=(
	"Bottles::git+https://github.com/bottlesdevs/Bottles.git#tag=${pkgver}"
	disable-flatpak-check.patch
	portable-config
	start.sh
)
sha256sums=('0f9d4f0e1bea536156abe7e0c49e537cd4289e119f955ab78415efddc369f0cb'
            '66fa37c964663e9933c9163e064be72830f3858c74429402f94d0470b9cb6f35'
            '15b16b8fdc61e5da2e62c80643351c1cbe981e5df4474564446e159ef7249766'
            'e8151fe783b4c202c99e206535f6f2b3e025b070d7237cb6f8bbb1f23ad0eb94')

function prepare() {
	patch --forward --directory="${srcdir}/${_pkgname}" --strip=1 --input="${srcdir}/disable-flatpak-check.patch"
}

build() {
	cd "${srcdir}/${_pkgname}"
	meson setup --prefix='/usr' build
	ninja -C build
}

package() {
	install -vDm755 "${srcdir}/portable-config" \
		"${pkgdir}/usr/lib/portable/info/com.usebottles.bottles/config"
	install -vDm755 "${srcdir}/start.sh" \
		"${pkgdir}/usr/bin/bottles-bwrap"
	cd "${srcdir}/${_pkgname}"
	DESTDIR="${pkgdir}" ninja -C build install
	install -d "${pkgdir}/usr/lib/bottles-bwrap"
	mv ${pkgdir}/usr/bin/bottles{,-cli} "${pkgdir}/usr/lib/bottles-bwrap"
	ln -srf "${pkgdir}/usr/bin/bottles-bwrap" "${pkgdir}/usr/bin/bottles"
}
