# Maintainer: Kimiblock Moe

pkgname=komikku-portable
pkgver=1
pkgrel=1
epoch=1
pkgdesc="Manga reader sandboxed by portable (prevents dGPU wakeups)"
arch=('x86_64')
url="https://github.com/Kraftland/portable"
license=('GPL-3.0-or-later')
groups=()
provides=(komikku)
options=(!debug !strip)
conflicts=("komikku")

optdepends=()

makedepends+=(komikku coreutils)

checkdepends=()

source=(
	portable-config
	komikku.sh
	komikku.desktop
)


md5sums=('1ce4e3c8db9bb3f86bbb0aaf5fd583bf'
         '7b9045a876cb70cfce509dcef69d6561'
         '7c0b0bae889e55058c366fc47d9edd25')

function prepare() {
	pacman -Ql komikku >file.list
}

function package() {
	depends=("portable")
	depends+=(alsa-lib  at-spi2-core  bash  cairo  dbus  ffmpeg4.4  fontconfig  freetype2  gcc-libs  gdk-pixbuf2  glib2  glibc  gtk3  hicolor-icon-theme  libpulse
                  libx11  libxcb  libxcomposite  libxdamage  libxext  libxfixes  libxrandr  libxss  libxt  mime-types  nspr  nss  pango  ttf-font)
	while IFS= read -r line; do
		file="$(echo "$line" | awk '{print $2}')"
		if [[ -d ${file} ]]; then
			echo "Omitting Directory"
		else
			if [[ -L "${file}" ]]; then
				mkdir -p "$(dirname "${pkgdir}/${file}")"
				ln -vsf "$(readlink -f "${file}")" "${pkgdir}/${file}"
			else
				install -vDm755 "${file}" "${pkgdir}/${file}"
			fi
		fi
	done < file.list
	rm -f "${pkgdir}/usr/share/applications"/*
	rm -f "${pkgdir}/usr/bin"/*
	install -vDm755 /usr/bin/komikku -t "${pkgdir}/usr/lib/portable/overlay-usr"
	install -Dm644 portable-config \
		"${pkgdir}/usr/lib/portable/info/info.febvre.Komikku/config"
	install -Dm755 "komikku.sh" \
		"${pkgdir}/usr/bin/komikku"
	install -Dm644 "komikku.desktop" "${pkgdir}/usr/share/applications/info.febvre.Komikku.desktop"
}
